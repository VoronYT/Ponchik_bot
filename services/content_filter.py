import logging
import re
from typing import Tuple, Optional

logger = logging.getLogger(__name__)

# --- ЗАЩИЩЁННЫЕ КАТЕГОРИИ (нельзя оскорблять) ---

NATIONALITIES = [
    # Славянские
    "русск", "русн", "украин", "хохол", "хохл", "беларус", "поляк", "польск",
    "чех", "словац", "болгар", "серб", "хорват",
    "словен", "босн", "македон",
    # Постсоветские
    "казах", "узбек", "киргиз", "туркмен", "таджик",
    "армян", "грузин", "азербайджан", "молдаван",
    # Кавказ
    "чечен", "ингуш", "дагестан", "кумык", "авар", "лезгин",
    "карачаев", "балкар", "осетин", "чурк",
    # Европа
    "немец", "немецк", "француз", "французск", "итальянец",
    "испанец", "португалец", "голланд", "датчан", "швед",
    "норвежц", "финн", "ирландец", "британ", "англичан",
    "шотланд", "валлиец",
    # Азия
    "китайц", "японц", "кореец", "вьетнамц", "тайц", "лаосц",
    "камбодж", "малайц", "филиппинец", "индиец", "пакистан",
    "афганц", "иранц", "иракец", "саудовец", "катарец",
    "эмиратц", "йеменец", "бангладешц", "непалец",
    # Африка
    "египтянин", "марокканец", "алжирец", "ливиец",
    "кениец", "эфиоп", "сомалиец", "нигериец",
    "конголезец", "угандиец", "мозамбикц",
    "замбиец", "суданец",
    # Америка
    "американец", "канадец", "мексиканец", "бразилец",
    "аргентинец", "чилиец", "боливиец", "колумбиец",
    "перуанец", "кубиец",
    # Австралия и Океания
    "австралиец", "новозеландец",
    # Расы
    "европеец", "азиат", "африканец", "латинос",
    "метис", "мулат", "белокож", "чернокож",
    # Другие
    "цыган", "евре", "семит", "негр", "нигер", "ниггер",
]


RELIGIONS = [
    "ислам", "мусульман", "суннит", "шиит",
    "христиан", "православ", "католик", "протестант",
    "иудей", "евре", "талмудист", "раввин",
    "буддист", "дзен", "ламаист",
    "индуист", "джайн", "сикх",
    "атеист", "агностик",
    # Конфессии/структуры
    "церков", "мечет", "синагог", "храм",
    "патриарх", "имам", "мулл", "пастор", "священник",
    # Другие религиозные группы/культы
    "кришнаит", "мормон", "свидетел", "адвентист",
    "кабалист", "синтоист", "таоист"
]


SOCIAL_GROUPS = [
    # Гендер / возраст
    # "женщин", "мужчин", "девушк", "парней",
    # "детей", "ребёнк", "подростк", "старик", "пожил",
    # "пенсионер",
    # Состояние здоровья / инвалидность
    "инвалид", "аутист", "аутичн", "диабетик",
    "глухонем", "слеп", "колясочник",
    # Социальное положение
    # "бездомн", "нищ", "бедн", "богат",
    # "рабоч", "крестьянин", "офисник",
    # "студент", "школьник",
    # Ориентация / идентичность
    "лгбт", "геи", "лесбиянк", "бисексуал",
    "трансгендер", "транс", "небинар",
    # Профессии (могут быть целью буллинга)
    # "полицейск", "военнослужащ", "врач",
    # "учитель", "айтишник", "программист",
]


PROTECTED_WORDS = NATIONALITIES + RELIGIONS + SOCIAL_GROUPS

# --- ОСКОРБЛЕНИЯ ---

INSULTS = [
    # Мат и сильные ругательства (умеренный набор, не слишком широкий)
    "говно", "говн", "гавно", "долбоеб", "долбаеб", "еблан",
    "идиот", "идиотка", "урод", "враг", "подонок", "ублюдок",
    "сука", "сукин", "мразь", "твар", "дебил", "кретин",
    "пидор", "пидар", "фашист", "расист"
]

# Создаём один общий регекс для оскорблений
if INSULTS:
    # Позволяем небольшие окончания (множественное число, падежи)
    INSULT_REGEX = re.compile(r"\b(?:" + "|".join([re.escape(s) + r"(?:\w*)" for s in INSULTS]) + r")\b", re.IGNORECASE)
else:
    INSULT_REGEX = None

# --- ОСНОВНАЯ ПРОВЕРКА ---

def contains_forbidden_target(text: str) -> Optional[str]:
    """Проверяет, направлены ли оскорбления на защищённые группы."""

    text_lower = text.lower()

    for target in PROTECTED_WORDS:
        if re.search(target, text_lower):
            # Если нет шаблонов для оскорблений — не считаем нейтральное упоминание за оскорбление
            if INSULT_REGEX is None:
                continue

            if INSULT_REGEX.search(text_lower):
                return target  # найдено оскорбление по группе

    return None


def contains_direct_prohibited_topics(text: str) -> Optional[str]:
    """Блокирует темы: терроризм, насилие, политика, геноцид и т.п."""

    FORBIDDEN_PATTERNS = [
        r"убей|уби(ть|вай)|взорв(и|ать)|резать|напасть",
        r"террор(изм|ист)",
        r"геноцид|массовое убийств",
        r"путин|зеленск|байден|трамп|макрон|президент|министр",
        r"санкции|войн(а|ой)|оккупац|аннекс"
    ]

    for p in FORBIDDEN_PATTERNS:
        if re.search(p, text.lower()):
            return p
    return None


# --- ОТВЕТ ФИЛЬТРА ---

def should_suppress_response(text: str) -> Tuple[bool, Optional[str]]:
    """Определяет, можно ли пропустить ответ токсичного персонажа."""

    targeted = contains_forbidden_target(text)
    if targeted:
        return True, f"Оскорбление защищённой группы ({targeted})"

    direct = contains_direct_prohibited_topics(text)
    if direct:
        return True, "Запрещённая высокая тема (политика/терроризм/насилие)"

    return False, None


# --- ФОЛБЭК ---

def safe_fallback() -> str:
    answers = [
        "Ладно, это уже перебор. Спроси что-нибудь нормальное.",
    ]
    import random
    return random.choice(answers)


# --- ОБЩАЯ ФУНКЦИЯ ---

def filter_and_validate_response(response: str, user_query: Optional[str] = None) -> Tuple[str, bool]:
    suppress, reason = should_suppress_response(response)

    if suppress:
        log_message = f"Ответ заблокирован: {reason}\nТекст: {response[:200]}"
        if user_query:
            log_message += f"\nЗапрос: {user_query}"
        logger.warning(log_message)
        return safe_fallback(), True

    return response, False
